generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  student
  teacher
  admin
}

enum QType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
}

enum Sender {
  user
  assistant
  system
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(student)
  timezone  String?
  language  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Profile            Profile?
  conversations      Conversation[]
  ownedLessons       Lesson[]
  ownedQuizzes       Quiz[]
  ownedFlashDecks    FlashDeck[]
  ownedStudyTasks    StudyTask[]
  bookmarks          Bookmark[]
  quizAttempts       QuizAttempt[]
  jobs               Job[]
}

model Profile {
  id      String @id @default(cuid())
  userId  String @unique
  bio     String?
  avatar  String?
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        String   @id @default(cuid())
  userId    String
  title     String
  language  String?
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  Message[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Message {
  id               String   @id @default(cuid())
  conversationId   String
  sender           Sender
  content          String
  contentJson      Json?
  model            String?
  provider         String?
  promptTokens     Int?
  completionTokens Int?
  latencyMs        Int?
  raw              Json?
  createdAt        DateTime @default(now())

  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model Lesson {
  id        String   @id @default(cuid())
  ownerId   String
  title     String
  content   String
  language  String?
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())

  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model Quiz {
  id        String   @id @default(cuid())
  ownerId   String
  title     String
  isPublic  Boolean  @default(false)
  language  String?
  createdAt DateTime @default(now())

  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]
}

model Question {
  id        String  @id @default(cuid())
  quizId    String
  type      QType
  prompt    String
  answer    String?
  order     Int

  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  choices   Choice[]
  answers   AttemptAnswer[]
}

model Choice {
  id         String @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)

  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  startedAt DateTime @default(now())
  finishedAt DateTime?
  score     Int      @default(0)

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz      Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers   AttemptAnswer[]

  @@index([userId, startedAt])
}

model AttemptAnswer {
  id         String @id @default(cuid())
  attemptId  String
  questionId String
  choiceId   String?
  text       String?
  correct    Boolean

  attempt    QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model FlashDeck {
  id        String   @id @default(cuid())
  ownerId   String
  title     String
  createdAt DateTime @default(now())

  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  cards     FlashCard[]
}

model FlashCard {
  id        String   @id @default(cuid())
  deckId    String
  front     String
  back      String
  ease      Float    @default(2.5)
  interval  Int      @default(1)
  due       DateTime @default(now())

  deck      FlashDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([deckId, due])
}

model StudyTask {
  id        String   @id @default(cuid())
  userId    String
  title     String
  details   String?
  due       DateTime
  repeat    String?
  status    String   @default("pending")
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, due])
}

model Bookmark {
  id       String   @id @default(cuid())
  userId   String
  kind     String
  targetId String
  createdAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Job {
  id          String   @id @default(cuid())
  type        String
  userId      String
  payload     Json
  status      String   @default("queued")
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  runAt       DateTime @default(now())
  nextRunAt   DateTime?
  result      Json?
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, runAt])
}

